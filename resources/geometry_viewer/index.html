<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>StaX Geometry Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; background: #2b2b2b; color: #e8e8e8; }
    #viewer { width: 100%; height: 100%; background: #333; display: block; }
    button { padding: 6px 10px; border-radius: 6px; border: none; background: #3a7bd5; color: #fff; cursor: pointer; }
    button:disabled { background: #555; cursor: default; }
  </style>
</head>
<body>
  <div id="viewer"></div>
  

  <script src="/dependencies/js-3d-model-viewer/dist/js-3d-model-viewer.min.js"></script>
  <script>
  (function() {
    var viewerEl = document.getElementById('viewer');

    function log() {
      if (window.console && window.console.log) {
        console.log.apply(console, arguments);
      }
    }

    function setStatus(text) {
      log('[status]', text);
    }

    function parseModelParam() {
      try {
        var params = new window.URLSearchParams(window.location.search);
        var raw = params.get('model');
        return raw ? decodeURIComponent(raw) : null;
      } catch (err) {
        log('Failed to read model query parameter:', err);
        return null;
      }
    }

    function cacheBusted(url) {
      if (!url) {
        return url;
      }
      var sep = url.indexOf('?') === -1 ? '?' : '&';
      return url + sep + 't=' + Date.now();
    }

    var player = window.Js3dModelViewer;
    if (!player || typeof player.prepareScene !== 'function') {
      setStatus('3D viewer library unavailable. Serve /dependencies/js-3d-model-viewer.');
      log('Js3dModelViewer global not found.');
      return;
    }

    setStatus('Preparing 3D viewer...');

    var scene = player.prepareScene(viewerEl, {
      grid: false,
      background: 'rgb(52, 52, 52)'
    });

    viewerEl.addEventListener('loading', function(evt) {
      if (!evt || !evt.detail) {
        return;
      }
      var detail = evt.detail;
      var total = detail.total || 100;
      var progress = total > 0 ? Math.floor((detail.loaded / total) * 100) : 0;
      setStatus('Loading model... ' + progress + '%');
    });

    viewerEl.addEventListener('loaded', function() {
      setStatus('Model loaded.');
    });

    viewerEl.addEventListener('error', function(evt) {
      setStatus('Failed to load model.');
      if (evt && evt.detail && evt.detail.err) {
        log('Viewer error:', evt.detail.err);
      }
    });

    function loadModel(url) {
      if (!url) {
        setStatus('No model provided.');
        return;
      }
      try {
        log('Loading model URL:', url);
        setStatus('Loading model...');
        var finalUrl = cacheBusted(url);
        player.clearScene(scene);
        player.resetCamera(scene);
        // player.showGrid(scene);
        player.loadGlb(scene, finalUrl, function(result) {
          if (!result || !result.scene) {
            if (result) {
              log('loadGlb callback payload:', result);
            }
          }
        });
      } catch (err) {
        setStatus('Error while loading model.');
        log('Exception raised during loadGlb:', err);
      }
    }

    loadModel(parseModelParam());
  })();
  </script>
</body>
</html>
